<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理 - 闲沐智能鱼缸系统v1.3</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/all.min.css') }}">
    <style>
        .schedule-card {
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .schedule-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .day-btn {
            width: 36px;
            height: 36px;
            padding: 0;
        }

        .portion-btn {
            width: 50px;
        }

        .log-entry {
            border-left: 4px solid #0d6efd;
            margin-bottom: 10px;
        }

        .header {
            padding-bottom: 10px;
            /* border-bottom: 1px solid #e5e5e5;*/
        }

        .bs-example {
            margin: 20px auto;
            background-color: #fff;
            border-color: #ddd;
            border-width: 1px;
            border-radius: 4px 4px 0 0;
            box-shadow: none;
            text-align: center;
        }

        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e5e5;
        }

        /* 消息提示动画 */
        .fade-in {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .delete-log-btn {
            transition: all 0.2s;
        }

        .delete-log-btn:hover {
            transform: scale(1.1);
            color: #dc3545 !important;
            border-color: #dc3545 !important;
        }

        .log-entry {
            transition: all 0.3s;
            overflow: hidden;
        }

        .log-entry:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
    <!-- 消息提示容器 - 固定在顶部 -->
    <div id="messageAlert" class="alert alert-dismissible fade show position-fixed top-0 start-0 end-0 m-0 rounded-0" style="display: none; z-index: 9999;">
        <span id="messageText"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div class="container py-4">
        <div class="header clearfix">
            <div class="bs-example">
                <h2 class="mb-4"><i class="fas fa-clock"></i> 计划任务管理</h2>
            </div>
            <nav>
                <ul class="nav nav-pills pull-right">
                    <li role="presentation">
                        <a href="/" class="btn btn-primary back-link">
                            <i class="fas fa-arrow-left"></i> 返回控制面板
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <div class="row">
            <!-- 计划列表 -->
            <div class="col-md-7">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list"></i> 任务计划</span>
                        <button class="btn btn-sm btn-primary" id="addScheduleBtn">
                            <i class="fas fa-plus"></i> 添加计划
                        </button>
                    </div>
                    <div class="card-body" id="schedulesList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 手动喂食和记录 -->
            <div class="col-md-5">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-bone"></i> 手动喂食
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">投喂量</label>
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-primary portion-btn active" data-portion="1">1次</button>
                                <button class="btn btn-outline-primary portion-btn" data-portion="2">2次</button>
                                <button class="btn btn-outline-primary portion-btn" data-portion="3">3次</button>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" id="feedNowBtn">
                            <i class="fas fa-play"></i> 立即喂食
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span><i class="fas fa-history"></i> 任务执行记录</span>
                        <span class="badge bg-secondary" id="logsCount">0条</span>
                    </div>
                    <div class="card-body" id="feedingLogs">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer text-center">
            <p>© 2025 闲沐工坊（请抖音关注） MiaoKing QQ：7740840</p>
        </footer>
    </div>

    <!-- 计划编辑模态框 -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">添加计划</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <input type="hidden" id="scheduleId">
                        <div class="mb-3">
                            <label class="form-label">计划名称</label>
                            <input type="text" class="form-control" id="scheduleName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">喂食时间</label>
                            <input type="time" class="form-control" id="feedTime" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">重复星期</label>
                            <div class="btn-group w-100 flex-wrap">
                                <button type="button" class="btn btn-outline-primary day-btn" data-day="0">日</button>
                                <button type="button" class="btn btn-outline-primary day-btn" data-day="1">一</button>
                                <button type="button" class="btn btn-outline-primary day-btn" data-day="2">二</button>
                                <button type="button" class="btn btn-outline-primary day-btn" data-day="3">三</button>
                                <button type="button" class="btn btn-outline-primary day-btn" data-day="4">四</button>
                                <button type="button" class="btn btn-outline-primary day-btn" data-day="5">五</button>
                                <button type="button" class="btn btn-outline-primary day-btn" data-day="6">六</button>
                            </div>
                            <input type="hidden" id="feedDays" value="1,2,3,4,5">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">投量</label>
                            <div class="btn-group w-100">
                                <button type="button" class="btn btn-outline-primary portion-btn active"
                                    data-portion="1">1次</button>
                                <button type="button" class="btn btn-outline-primary portion-btn"
                                    data-portion="2">2次</button>
                                <button type="button" class="btn btn-outline-primary portion-btn"
                                    data-portion="3">3次</button>
                            </div>
                            <input type="hidden" id="portionSize" value="1">
                        </div>
                         <div class="mb-3">
                            <label class="form-label">类别</label>
                            <div class="btn-group w-100">
                                <button type="button" class="btn btn-outline-primary typeid-btn active"
                                    data-portion="0">喂食</button>
                                <button type="button" class="btn btn-outline-primary typeid-btn"
                                    data-portion="1">风扇</button>
                                <button type="button" class="btn btn-outline-primary typeid-btn"
                                    data-portion="2">气泵</button>
                                <button type="button" class="btn btn-outline-primary typeid-btn"
                                    data-portion="3">灌溉</button>
                            </div>
                            <input type="hidden" id="typeid" value="0">
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="scheduleEnabled" checked>
                            <label class="form-check-label" for="scheduleEnabled">启用计划</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveScheduleBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // 全局变量
        let currentScheduleId = null;
        let selectedDays = [1, 2, 3, 4, 5]; // 默认工作日
        let isLocalNetwork = false;

        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 加载喂食计划和记录
            loadSchedules();
            loadFeedingLogs();

            // 初始化模态框
            const scheduleModal = new bootstrap.Modal('#scheduleModal');

            checkNetworkEnvironment();

            // 添加计划按钮
            document.getElementById('addScheduleBtn').addEventListener('click', function () {
                currentScheduleId = null;
                document.getElementById('modalTitle').textContent = '添加喂食计划';
                document.getElementById('scheduleForm').reset();
                document.getElementById('feedDays').value = '1,2,3,4,5';
                selectedDays = [1, 2, 3, 4, 5];
                updateDayButtons();
                scheduleModal.show();
            });

            // 星期选择按钮
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const day = parseInt(this.dataset.day);
                    const index = selectedDays.indexOf(day);

                    if (index === -1) {
                        selectedDays.push(day);
                        this.classList.add('active');
                    } else {
                        selectedDays.splice(index, 1);
                        this.classList.remove('active');
                    }

                    document.getElementById('feedDays').value = selectedDays.join(',');
                });
            });

            // 投喂量选择
            document.querySelectorAll('.portion-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.portion-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('portionSize').value = this.dataset.portion;
                });
            });

            // 类别选择
            document.querySelectorAll('.typeid-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.typeid-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('typeid').value = this.dataset.portion
                });
            });

            // 保存计划
            document.getElementById('saveScheduleBtn').addEventListener('click', function () {
                const form = document.getElementById('scheduleForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const formData = {
                    enabled: document.getElementById('scheduleEnabled').checked ? 1 : 0,
                    schedule_name: document.getElementById('scheduleName').value,
                    feed_time: document.getElementById('feedTime').value,
                    feed_days: document.getElementById('feedDays').value,
                    portion_size: document.getElementById('portionSize').value,
                    typeid: document.getElementById('typeid').value
                };

                if (currentScheduleId) {
                    formData.id = currentScheduleId;
                }

                fetch('/api/feeding/schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // 获取模态框实例并隐藏
                            const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                            modal.hide();
                            loadSchedules();
                        } else {
                            alert('保存失败: ' + (data.message || '未知错误'));
                        }
                    })
                    .catch(error => {
                        console.error('保存出错:', error);
                        alert('保存出错: ' + error.message);
                    });
            });

            // 立即喂食
            document.getElementById('feedNowBtn').addEventListener('click', function () {
                const portion = document.querySelector('.portion-btn.active').dataset.portion;
                const btn = this;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 喂食中...';
                btn.disabled = true;

                fetch('/feed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ portion_size: portion })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            loadFeedingLogs();
                        } else {
                            showMessage('投喂失败: ' + (data.message || '未知错误'), 'danger');
                        }
                        btn.innerHTML = '<i class="fas fa-play"></i> 立即喂食';
                        btn.disabled = false;
                    })
                    .catch(() => {
                        btn.innerHTML = '<i class="fas fa-play"></i> 立即喂食';
                        btn.disabled = false;
                    });
                ;
            });
        });

        function showMessage(message, type = 'info') {
            // 确保消息容器存在
            let alertBox = document.getElementById('messageAlert');
            let messageText = document.getElementById('messageText');
            
            // 如果元素不存在，重新创建
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'messageAlert';
                alertBox.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-0 end-0 m-0 rounded-0`;
                alertBox.style.zIndex = '9999';
                
                messageText = document.createElement('span');
                messageText.id = 'messageText';
                
                const closeBtn = document.createElement('button');
                closeBtn.type = 'button';
                closeBtn.className = 'btn-close';
                closeBtn.setAttribute('data-bs-dismiss', 'alert');
                closeBtn.setAttribute('aria-label', 'Close');
                
                alertBox.appendChild(messageText);
                alertBox.appendChild(closeBtn);
                document.body.prepend(alertBox);
            }
            
            // 更新消息内容和样式
            messageText.textContent = message;
            alertBox.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-0 end-0 m-0 rounded-0`;
            alertBox.style.display = 'block';
            
            // 初始化Bootstrap Alert组件
            const bsAlert = new bootstrap.Alert(alertBox);
            
            // 5秒后自动消失
            setTimeout(() => {
                bsAlert.close();
            }, 5000);
        }

        // 关闭消息函数
        function closeMessage() {
            const alert = document.getElementById('messageAlert');
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }

        // 加载计划
        function loadSchedules() {
            fetch('/api/feeding/schedules')
                .then(response => response.json())
                .then(schedules => {
                    const container = document.getElementById('schedulesList');
                    container.innerHTML = '';

                    if (schedules.length === 0) {
                        container.innerHTML = '<div class="text-center py-4 text-muted">暂无计划</div>';
                        return;
                    }

                    schedules.forEach(schedule => {
                        const daysMap = { 0: '日', 1: '一', 2: '二', 3: '三', 4: '四', 5: '五', 6: '六' };
                        const daysText = schedule.feed_days.map(d => daysMap[d]).join('、');

                        const card = document.createElement('div');
                        card.className = `schedule-card card ${schedule.enabled ? '' : 'bg-light'}`;
                        card.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title mb-0">
                                    ${schedule.schedule_name}
                                    ${schedule.enabled ? '' : '<span class="badge bg-secondary ms-2">已禁用</span>'}
                                </h5>
                                <div class="form-check form-switch">
                                    
                                </div>
                            </div>
                            <div class="d-flex justify-content-between text-muted mb-2">
                                <span><i class="fas fa-clock"></i> ${schedule.feed_time}</span>
                                <span><i class="fas fa-repeat"></i> 每周${daysText}</span>
                                <span><i class="fas fa-bone"></i> ${schedule.portion_size}次</span>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-primary me-2 edit-schedule" 
                                    data-id="${schedule.id}">编辑</button>
                                <button class="btn btn-sm btn-outline-danger delete-schedule" 
                                    data-id="${schedule.id}">删除</button>
                            </div>
                        </div>
                    `;
                        container.appendChild(card);
                    });

                    // 绑定编辑和删除事件
                    document.querySelectorAll('.edit-schedule').forEach(btn => {
                        btn.addEventListener('click', function () {
                            editSchedule(parseInt(this.dataset.id));
                        });
                    });

                    document.querySelectorAll('.delete-schedule').forEach(btn => {
                        btn.addEventListener('click', function () {
                            if (confirm('确定要删除这个计划吗？')) {
                                deleteSchedule(parseInt(this.dataset.id));
                            }
                        });
                    });

                    // 绑定启用/禁用切换
                    document.querySelectorAll('.schedule-toggle').forEach(toggle => {
                        toggle.addEventListener('change', function () {
                            const originalState = this.checked;
                            this.checked = !originalState; // 先恢复原状态
                            toggleSchedule(parseInt(this.dataset.id), originalState);
                        });
                    });
                });
        }

        function loadFeedingLogs() {
            fetch('/api/feeding/logs?limit=15')
                .then(response => response.json())
                .then(logs => {
                    const container = document.getElementById('feedingLogs');
                    document.getElementById('logsCount').textContent = `${logs.length}条`;

                    if (logs.length === 0) {
                        container.innerHTML = '<div class="text-center py-4 text-muted">暂无记录</div>';
                        return;
                    }

                    container.innerHTML = '';
                    logs.forEach(log => {
                        const date = new Date(log.feed_time * 1000);
                        const timeStr = date.toLocaleString();

                        const entry = document.createElement('div');
                        entry.className = 'log-entry p-3 bg-light rounded mb-2 position-relative';
                        entry.innerHTML = `
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${timeStr}</strong>
                        ${log.schedule_name ? `<div class="text-muted small">计划: ${log.schedule_name}</div>` : ''}
                    </div>
                    <div>
                        <span class="badge bg-primary">${log.portion_size}次</span>
                        <button class="btn btn-sm btn-outline-danger delete-log-btn ms-2" data-id="${log.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
                        container.appendChild(entry);
                    });

                    // 绑定删除按钮事件
                    document.querySelectorAll('.delete-log-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const logId = this.dataset.id;
                            deleteFeedingLog(logId);
                        });
                    });
                });
        }

        // 检测网络环境
        function checkNetworkEnvironment() {
            return fetch('/api/check_network')
                .then(response => response.json())
                .then(data => {
                    isLocalNetwork = data.is_local;                    
                    return isLocalNetwork;
                })
                .catch(error => {
                    console.error('检查网络环境失败:', error);
                    isLocalNetwork = false; // 默认不允许删除
                    return false;
                });
        }


        function deleteFeedingLog(logId) {
            if (!isLocalNetwork) {
                showMessage('删除功能仅限内网使用，请连接到本地网络后再试', 'warning');
                return;
            }

            if (confirm('确定要删除这条记录吗？此操作不可撤销！')) {
                const deleteBtn = document.querySelector(`.delete-log-btn[data-id="${logId}"]`);
                const originalHtml = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                deleteBtn.disabled = true;

                fetch(`/api/feeding/logs/${logId}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || '删除失败');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    showMessage('记录删除成功！', 'success');
                    
                    // 动画效果移除记录
                    const logEntry = deleteBtn.closest('.log-entry');
                    logEntry.style.transition = 'all 0.3s ease';
                    logEntry.style.opacity = '0';
                    logEntry.style.height = logEntry.offsetHeight + 'px';
                    
                    setTimeout(() => {
                        logEntry.style.height = '0';
                        logEntry.style.margin = '0';
                        logEntry.style.padding = '0';
                        
                        setTimeout(() => {
                            logEntry.remove();
                            updateLogsCount();
                        }, 300);
                    }, 10);
                })
                .catch(error => {
                    showMessage('删除失败: ' + error.message, 'danger');
                    deleteBtn.innerHTML = originalHtml;
                    deleteBtn.disabled = false;
                });
            }
        }

        function updateLogsCount() {
            const count = document.querySelectorAll('.log-entry').length;
            document.getElementById('logsCount').textContent = `${count}条`;
        }

        // 编辑计划
        function editSchedule(id) {
            fetch('/api/feeding/schedules')
                .then(response => response.json())
                .then(schedules => {
                    const schedule = schedules.find(s => s.id === id);
                    if (schedule) {
                        currentScheduleId = id;
                        document.getElementById('modalTitle').textContent = '编辑喂食计划';
                        document.getElementById('scheduleId').value = id;
                        document.getElementById('scheduleName').value = schedule.schedule_name;
                        document.getElementById('feedTime').value = schedule.feed_time;
                        document.getElementById('scheduleEnabled').checked = schedule.enabled;

                        // 设置星期选择
                        selectedDays = schedule.feed_days.map(d => parseInt(d));
                        updateDayButtons();
                        document.getElementById('feedDays').value = selectedDays.join(',');

                        // 设置执行次数
                        document.querySelectorAll('.portion-btn').forEach(btn => {
                            btn.classList.toggle('active', parseInt(btn.dataset.portion) === schedule.portion_size);
                        });
                        document.getElementById('portionSize').value = schedule.portion_size;

                        // 设置类别
                        document.querySelectorAll('.typeid-btn').forEach(btn => {
                            btn.classList.toggle('active', parseInt(btn.dataset.portion) === schedule.typeid);
                        });
                        document.getElementById('typeid').value = schedule.typeid;

                        // 显示模态框
                        const scheduleModal = new bootstrap.Modal('#scheduleModal');
                        scheduleModal.show();
                    }
                });
        }

        // 更新星期选择按钮状态
        function updateDayButtons() {
            document.querySelectorAll('.day-btn').forEach(btn => {
                const day = parseInt(btn.dataset.day);
                btn.classList.toggle('active', selectedDays.includes(day));
            });
        }

        // 删除计划
        function deleteSchedule(id) {
            fetch(`/api/feeding/schedules/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || '删除失败');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        loadSchedules();
                    }
                })
                .catch(error => {
                    alert('删除失败: ' + error.message);
                });
        }

        // 切换计划状态
        // 替换原有的toggleSchedule函数
        function toggleSchedule(id, enabled) {
            const toggle = document.querySelector(`.schedule-toggle[data-id="${id}"]`);
            const card = toggle.closest('.schedule-card');

            // 立即更新UI反馈
            toggle.disabled = true;
            if (enabled) {
                card.classList.remove('bg-light');
            } else {
                card.classList.add('bg-light');
            }

            fetch('/api/feeding/schedules/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: id,
                    enabled: enabled
                })
            })
                .then(response => {
                    if (!response.ok) throw new Error('HTTP错误');
                    return response.json();
                })
                .then(data => {
                    if (data.status !== 'success') {
                        throw new Error(data.message || '操作失败');
                    }
                    // 更新状态标签
                    const badge = card.querySelector('.badge');
                    if (enabled) {
                        if (badge) badge.remove();
                    } else {
                        if (!badge) {
                            const title = card.querySelector('.card-title');
                            title.insertAdjacentHTML('beforeend',
                                '<span class="badge bg-secondary ms-2">已禁用</span>');
                        }
                    }
                })
                .catch(error => {
                    // 恢复原始状态
                    toggle.checked = !enabled;
                    if (enabled) {
                        card.classList.add('bg-light');
                    } else {
                        card.classList.remove('bg-light');
                    }
                    alert('操作失败: ' + error.message);
                })
                .finally(() => {
                    toggle.disabled = false;
                });
        }
    </script>
</body>

</html>